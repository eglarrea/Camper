<main>
  <h1>Historial de Reservas</h1>

  <section>
    <form [formGroup]="filterForm" (ngSubmit)="applyFilters()">
      <div>
        <div>
          <label>Desde</label>
          <input type="date" formControlName="fechaDesde" class="form-control">
        </div>
        
        <div>
          <label>Hasta</label>
          <input type="date" formControlName="fechaHasta">
        </div>

        <div>
          <label>Parking</label>
          <input type="text" formControlName="nombreParking" placeholder="Nombre...">
        </div>

        <div>
          <label>Estado</label>
          <select formControlName="estado">
            <option value="">Todos</option>
            <option value="1">Confirmada</option>
            <option value="0">Cancelada</option>
          </select>
        </div>

        <div>
          <button type="submit">Filtrar</button>
          <button type="button" (click)="clearFilters()">Limpiar</button>
        </div>
      </div>
    </form>
  </section>

  <div *ngIf="isLoading">
    <p>Cargando historial...</p>
  </div>

  <div *ngIf="!isLoading">
    
    <div *ngIf="filteredBookings.length === 0">
      <p>No se encontraron reservas con estos criterios.</p>
    </div>

    <article *ngFor="let booking of filteredBookings" [class.cancelled]="booking.estado === '0'">
      <div>
        <div>
          <h2>{{ booking.parkingNombre || 'Parking #' + booking.parkingId }}</h2>
          <span>Solicitada el: {{ booking.fecAlta | date:'dd/MM/yyyy' }}</span>
        </div>
        <span [ngClass]="{'confirmed': booking.estado === '1', 'cancelled': booking.estado === '0'}">
          {{ getStatusLabel(booking.estado) }}
        </span>
      </div>

      <div>
        <div>
          <strong>Fechas:</strong>
          <span *ngIf="booking.fecInicio && booking.fecFin; else noDates">
            {{ booking.fecInicio | date:'dd/MM/yyyy' }} - {{ booking.fecFin | date:'dd/MM/yyyy' }}
          </span>
          <ng-template #noDates><span>--/--/----</span></ng-template>
        </div>

        <div>
          <strong>Plaza:</strong>
          <span>ID {{ booking.plazaId }}</span>
        </div>

        <div>
          <strong>Total:</strong>
          <span>{{ (booking.precioTotal > 0 ? booking.precioTotal : booking.precio) | currency:'EUR' }}</span>
        </div>
      </div>

      <div>
        <button *ngIf="booking.estado === '1'" (click)="cancelBooking(booking.id)">
          Cancelar Reserva
        </button>
      </div>
    </article>
  </div>
</main>
