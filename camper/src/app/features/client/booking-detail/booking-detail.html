<main class="booking-detail-page">

  <!-- Volver -->
  <div class="back-row">
    <button class="btn btn-secondary" (click)="goBack()">
      ← {{ 'HISTORY_DETAIL.BACK' | translate }}
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-wrapper">
    <i class="fa-solid fa-spinner spinner"></i>
    <p>{{ 'HISTORY_DETAIL.LOADING_DETAIL' | translate }}</p>
  </div>

  <!-- Error -->
  <p *ngIf="errorMessage" class="error-msg-standard">
    {{ errorMessage }}
  </p>

  <!-- Contenido -->
  <div *ngIf="!isLoading && booking" class="booking-card">

    <!-- HEADER -->
    <header class="booking-header">
      <div>
        <h1>{{ booking.parkingNombre || booking.nombreParking || ('HISTORY_DETAIL.BOOKING' | translate) + ' #' + booking.id }}</h1>
        <small>
          {{ 'HISTORY_DETAIL.REQUEST_DATE' | translate }}:
          {{ (booking.fecAlta || booking.fechaRealizacion) | date:'dd/MM/yyyy HH:mm' }}
        </small>
      </div>

      <span
        class="status"
        [class.confirmed]="booking.estado === '1'"
        [class.cancelled]="booking.estado === '0'"
      >
        {{ getStatusLabel(booking.estado) | translate }}
      </span>
    </header>

    <!-- INFO GRID -->
    <div class="booking-info">

      <section>
        <h3>{{ 'HISTORY_DETAIL.GENERAL' | translate }}</h3>
        <p><strong>{{ 'HISTORY_DETAIL.REFERENCE' | translate }}:</strong> #{{ booking.id }}</p>
        <p><strong>{{ 'HISTORY_DETAIL.SPOT' | translate }}:</strong> {{ booking.plazaId || booking.plazaNombre }}</p>
      </section>

      <section>
        <h3>{{ 'HISTORY_DETAIL.STAY' | translate }}</h3>
        <p><strong>{{ 'HISTORY_DETAIL.ENTRY' | translate }}:</strong> {{ (booking.fecInicio || booking.fechaEntrada) | date:'dd/MM/yyyy' }}</p>
        <p><strong>{{ 'HISTORY_DETAIL.EXIT' | translate }}:</strong> {{ (booking.fecFin || booking.fechaSalida) | date:'dd/MM/yyyy' }}</p>
        <p><strong>{{ 'HISTORY_DETAIL.TOTAL' | translate }}:</strong> {{ (booking.precioTotal || booking.precio) | currency:'EUR' }}</p>
      </section>

      <section *ngIf="booking.puntuacion">
        <h3>{{ 'HISTORY_DETAIL.RATING' | translate }}</h3>
        <p class="rating">
          {{ booking.puntuacion }} / 10 ★
        </p>
      </section>

    </div>

    <!-- ACTIONS -->
    <div class="booking-actions" *ngIf="booking.estado === '1'">
      <button class="btn btn-secondary" (click)="viewQr()">
        {{ 'HISTORY_DETAIL.QR' | translate }}
      </button>

      <button class="btn btn-secondary" (click)="rateBooking()">
        {{ 'HISTORY_DETAIL.RATE' | translate }}
      </button>

      <button class="btn btn-danger" (click)="cancelBooking()">
        {{ 'HISTORY_DETAIL.CANCEL' | translate }}
      </button>
    </div>

    <p *ngIf="booking.estado === '0'" class="cancelled-msg">
      {{ 'HISTORY_DETAIL.CANCELLED_MSG' | translate }}
    </p>

  </div>
</main>

<!-- MODAL QR -->
<div *ngIf="showQrModal" class="qr-modal" (click)="closeQrModal()">
  <div class="qr-box" (click)="$event.stopPropagation()">
    <div class="qr-header">
      <h2>{{ 'HISTORY_DETAIL.QR_TITLE' | translate }}</h2>
      <button (click)="closeQrModal()">×</button>
    </div>

    <div class="qr-body">
      <img *ngIf="currentQrCode" [src]="'data:image/png;base64,' + currentQrCode">
      <p *ngIf="!currentQrCode">{{ 'HISTORY_DETAIL.LOADING_QR' | translate }}</p>
    </div>
  </div>
</div>